{% extends "base.html" %}

{% block title %}Audit Log - MCP Hub{% endblock %}

{% block content %}
<div class="space-y-6">
    <div>
        <h1 class="text-2xl font-bold text-slate-900">Audit Log</h1>
        <p class="mt-1 text-sm text-slate-500">Track all MCP tool calls and actions</p>
    </div>

    <div class="grid grid-cols-1 gap-4 sm:grid-cols-2 lg:grid-cols-5">
        <div class="bg-white shadow-sm rounded-xl border border-slate-200 p-4">
            <p class="text-xs text-slate-500">Total calls{% if stats.has_filters %} <span class="text-primary-600">(filtered)</span>{% endif %}</p>
            <p class="mt-1 text-2xl font-semibold text-slate-900">{{ stats.total_calls }}</p>
        </div>
        <div class="bg-white shadow-sm rounded-xl border border-slate-200 p-4">
            <p class="text-xs text-slate-500">Calls (24h){% if stats.has_filters %} <span class="text-primary-600">(filtered)</span>{% endif %}</p>
            <p class="mt-1 text-2xl font-semibold text-slate-900">{{ stats.calls_24h }}</p>
        </div>
        <div class="bg-white shadow-sm rounded-xl border border-slate-200 p-4">
            <p class="text-xs text-slate-500">Unique users{% if stats.has_filters %} <span class="text-primary-600">(filtered)</span>{% endif %}</p>
            <p class="mt-1 text-2xl font-semibold text-slate-900">{{ stats.unique_users }}</p>
        </div>
        <div class="bg-white shadow-sm rounded-xl border border-slate-200 p-4">
            <p class="text-xs text-slate-500">Errors{% if stats.has_filters %} <span class="text-primary-600">(filtered)</span>{% endif %}</p>
            <p class="mt-1 text-2xl font-semibold {% if stats.errors > 0 %}text-red-600{% else %}text-slate-900{% endif %}">{{ stats.errors }}</p>
        </div>
        <div class="bg-white shadow-sm rounded-xl border border-slate-200 p-4">
            <p class="text-xs text-slate-500">Connected integrations</p>
            <p class="mt-1 text-2xl font-semibold text-slate-900">{{ stats.active_connections }}</p>
        </div>
    </div>

    <div class="bg-white shadow-sm rounded-xl border border-slate-200 p-4">
        <div class="flex flex-wrap items-center justify-between gap-2">
            <h2 class="text-sm font-semibold text-slate-900">Connections by provider</h2>
            <span class="text-xs text-slate-500">Connected now</span>
        </div>
        <div class="mt-3 flex flex-wrap gap-2">
            {% if connections_by_provider %}
                {% for item in connections_by_provider %}
                <span class="inline-flex items-center px-2.5 py-1 rounded-full text-xs font-medium bg-slate-100 text-slate-700">
                    {{ item.provider }} Â· {{ item.count }}
                </span>
                {% endfor %}
            {% else %}
                <span class="text-xs text-slate-500">No active connections yet.</span>
            {% endif %}
        </div>
    </div>

    <!-- Filters -->
    <div class="bg-white shadow-sm rounded-xl border border-slate-200 p-6">
        <div class="flex items-center justify-between mb-4">
            <h2 class="text-sm font-semibold text-slate-900">Filters</h2>
            {% if stats.has_filters %}
            <a href="/admin/audit"
               class="inline-flex items-center px-3 py-1.5 text-xs font-medium text-slate-600 border border-slate-300 rounded-lg hover:bg-slate-50 transition-colors">
                <svg class="w-3 h-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                </svg>
                Clear All
            </a>
            {% endif %}
        </div>
        <form id="filter-form" class="grid grid-cols-1 gap-4 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-6">
            <div>
                <label class="block text-sm font-medium text-slate-700 mb-1">User</label>
                <select name="user_id" class="audit-filter block w-full px-3 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500">
                    <option value="">All Users</option>
                    {% for u in users %}
                    <option value="{{ u.id }}" {% if filters.user_id == u.id %}selected{% endif %}>{{ u.email }}</option>
                    {% endfor %}
                </select>
            </div>
            <div>
                <label class="block text-sm font-medium text-slate-700 mb-1">Provider</label>
                <select name="provider" class="audit-filter block w-full px-3 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500">
                    <option value="">All Providers</option>
                    <option value="teamwork" {% if filters.provider == 'teamwork' %}selected{% endif %}>Teamwork</option>
                    <option value="slack" {% if filters.provider == 'slack' %}selected{% endif %}>Slack</option>
                    <option value="miro" {% if filters.provider == 'miro' %}selected{% endif %}>Miro</option>
                    <option value="figma" {% if filters.provider == 'figma' %}selected{% endif %}>Figma</option>
                    <option value="telegram" {% if filters.provider == 'telegram' %}selected{% endif %}>Telegram</option>
                    <option value="hub" {% if filters.provider == 'hub' %}selected{% endif %}>Hub</option>
                </select>
            </div>
            <div>
                <label class="block text-sm font-medium text-slate-700 mb-1">Action</label>
                <select name="action" class="audit-filter block w-full px-3 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500">
                    <option value="">All Actions</option>
                    {% for act in distinct_actions %}
                    <option value="{{ act }}" {% if filters.action == act %}selected{% endif %}>{{ act }}</option>
                    {% endfor %}
                </select>
            </div>
            <div>
                <label class="block text-sm font-medium text-slate-700 mb-1">Status</label>
                <select name="status" class="audit-filter block w-full px-3 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500">
                    <option value="">All</option>
                    <option value="ok" {% if filters.status == 'ok' %}selected{% endif %}>OK</option>
                    <option value="error" {% if filters.status == 'error' %}selected{% endif %}>Error</option>
                </select>
            </div>
            <div>
                <label class="block text-sm font-medium text-slate-700 mb-1">Date From</label>
                <input type="date" name="date_from" value="{{ filters.date_from or '' }}"
                       class="audit-filter block w-full px-3 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500">
            </div>
            <div>
                <label class="block text-sm font-medium text-slate-700 mb-1">Date To</label>
                <input type="date" name="date_to" value="{{ filters.date_to or '' }}"
                       class="audit-filter block w-full px-3 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500">
            </div>
        </form>
    </div>

    <!-- Logs Table -->
    <div class="bg-white shadow-sm rounded-xl border border-slate-200 overflow-hidden">
        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-slate-200">
                <thead class="bg-slate-50">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider w-8"></th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Timestamp</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">User</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Provider</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Action</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Status</th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-slate-200">
                    {% for log in logs %}
                    <tr class="hover:bg-slate-50 transition-colors cursor-pointer log-row" data-log-id="{{ log.id }}">
                        <td class="px-6 py-4 whitespace-nowrap">
                            <svg class="w-4 h-4 text-slate-400 transform transition-transform expand-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                            </svg>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-500">
                            {{ log.created_at[:19] }}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span class="text-sm text-slate-900">{{ log.user_email or 'System' }}</span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            {% if log.provider == 'teamwork' %}
                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-purple-100 text-purple-800">
                                Teamwork
                            </span>
                            {% elif log.provider == 'slack' %}
                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-emerald-100 text-emerald-800">
                                Slack
                            </span>
                            {% elif log.provider == 'miro' %}
                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800">
                                Miro
                            </span>
                            {% elif log.provider == 'figma' %}
                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-pink-100 text-pink-800">
                                Figma
                            </span>
                            {% elif log.provider == 'telegram' %}
                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-sky-100 text-sky-800">
                                Telegram
                            </span>
                            {% elif log.provider == 'hub' %}
                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-indigo-100 text-indigo-800">
                                Hub
                            </span>
                            {% else %}
                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-slate-100 text-slate-600">
                                {{ log.provider or '-' }}
                            </span>
                            {% endif %}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <code class="text-sm bg-slate-100 text-slate-800 px-2 py-1 rounded font-mono">{{ log.action_display or log.action }}</code>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            {% if log.status == 'ok' %}
                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-emerald-100 text-emerald-800">
                                <svg class="w-3 h-3 mr-1" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/>
                                </svg>
                                OK
                            </span>
                            {% else %}
                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-800">
                                <svg class="w-3 h-3 mr-1" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"/>
                                </svg>
                                Error
                            </span>
                            {% endif %}
                        </td>
                    </tr>
                    <!-- Expandable details row -->
                    <tr class="log-details hidden" data-details-for="{{ log.id }}">
                        <td colspan="6" class="px-6 py-4 bg-slate-50">
                            <div class="space-y-4">
                                {% if log.status != 'ok' and log.error_text %}
                                <div>
                                    <h4 class="text-xs font-semibold text-red-600 uppercase mb-2">Error</h4>
                                    <div class="bg-red-50 border border-red-200 rounded-lg p-3">
                                        <pre class="text-sm text-red-800 whitespace-pre-wrap break-words font-mono">{{ log.error_text }}</pre>
                                    </div>
                                </div>
                                {% endif %}

                                {% if log.request_json %}
                                <div>
                                    <h4 class="text-xs font-semibold text-slate-500 uppercase mb-2">Request Parameters</h4>
                                    <div class="bg-white border border-slate-200 rounded-lg p-3 overflow-x-auto">
                                        <pre class="text-sm text-slate-700 whitespace-pre-wrap break-words font-mono request-json" data-raw="{{ log.request_json }}">{{ log.request_json }}</pre>
                                    </div>
                                </div>
                                {% endif %}

                                {% if log.response_json %}
                                <div>
                                    <h4 class="text-xs font-semibold text-slate-500 uppercase mb-2">Response</h4>
                                    <div class="bg-white border border-slate-200 rounded-lg p-3 overflow-x-auto max-h-64 overflow-y-auto">
                                        <pre class="text-sm text-slate-700 whitespace-pre-wrap break-words font-mono response-json" data-raw="{{ log.response_json }}">{{ log.response_json }}</pre>
                                    </div>
                                </div>
                                {% endif %}

                                {% if not log.request_json and not log.response_json and not log.error_text %}
                                <p class="text-sm text-slate-500">No additional details available</p>
                                {% endif %}
                            </div>
                        </td>
                    </tr>
                    {% endfor %}

                    {% if not logs %}
                    <tr>
                        <td colspan="6" class="px-6 py-12 text-center">
                            <svg class="mx-auto h-12 w-12 text-slate-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/>
                            </svg>
                            <p class="mt-2 text-sm text-slate-500">No audit logs found</p>
                            {% if stats.has_filters %}
                            <a href="/admin/audit" class="mt-2 inline-flex items-center text-sm text-primary-600 hover:text-primary-800">Clear filters</a>
                            {% endif %}
                        </td>
                    </tr>
                    {% endif %}
                </tbody>
            </table>
        </div>
    </div>

    {% if logs|length >= 100 %}
    <div class="flex justify-center">
        <a href="?offset={{ (filters.offset or 0) + 100 }}{% if filters.user_id %}&user_id={{ filters.user_id }}{% endif %}{% if filters.provider %}&provider={{ filters.provider|urlencode }}{% endif %}{% if filters.action %}&action={{ filters.action|urlencode }}{% endif %}{% if filters.status %}&status={{ filters.status|urlencode }}{% endif %}{% if filters.date_from %}&date_from={{ filters.date_from|urlencode }}{% endif %}{% if filters.date_to %}&date_to={{ filters.date_to|urlencode }}{% endif %}"
           class="inline-flex items-center px-4 py-2 border border-slate-300 rounded-lg text-slate-700 hover:bg-slate-50 transition-colors">
            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
            </svg>
            Load More
        </a>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block scripts %}
<script>
    // Dynamic filters: auto-apply on any change
    document.querySelectorAll('.audit-filter').forEach(el => {
        el.addEventListener('change', () => {
            applyFilters();
        });
    });

    function applyFilters() {
        const form = document.getElementById('filter-form');
        const formData = new FormData(form);
        const params = new URLSearchParams();
        for (const [key, value] of formData) {
            if (value) params.append(key, value);
        }
        window.location.href = '/admin/audit?' + params.toString();
    }

    // Expand/collapse log details
    document.querySelectorAll('.log-row').forEach(row => {
        row.addEventListener('click', () => {
            const logId = row.dataset.logId;
            const detailsRow = document.querySelector(`[data-details-for="${logId}"]`);
            const icon = row.querySelector('.expand-icon');

            if (detailsRow) {
                detailsRow.classList.toggle('hidden');
                icon.classList.toggle('rotate-90');
            }
        });
    });

    // Format JSON for better readability
    document.querySelectorAll('.request-json, .response-json').forEach(pre => {
        try {
            const raw = pre.dataset.raw;
            if (raw) {
                const parsed = JSON.parse(raw);
                pre.textContent = JSON.stringify(parsed, null, 2);
            }
        } catch (e) {
            // Keep original text if not valid JSON
        }
    });
</script>
{% endblock %}
